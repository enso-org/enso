from Standard.Base import all
from Standard.Table import Column, Table, Bits, Value_Type
from Standard.Test import all
from Standard.Table.Errors import all
import Standard.Base.Errors.Common.Type_Error
import Standard.Base.Errors.Illegal_Argument.Illegal_Argument

from project.Util import all

type Data
    #   | Flight | Passenger | Ticket Price
    #---+--------+-----------+--------------
    # 0 | BA0123 | A         | 100.5
    # 1 | BA0123 | B         | 575.99
    # 2 | SG0456 | A         | 73.23
    # 3 | BA0123 | C         | 112.34
    # 4 | SG0456 | E         | 73.77
    Value ~table ~integer_table

    setup =
        flight = ["Flight", ["BA0123", "BA0123", "SG0456", "BA0123", "SG0456"]]
        passenger = ["Passenger", ["A", "B", "A", "C", "E"]]
        make_table =
            ticket_price = ["Ticket Price", [100.50, 575.99, 73.23, 112.34, 73.77]]
            Table.new [flight, passenger, ticket_price]
        make_integer_table =
            ticket_price = ["Ticket Price", [101, 576, 73, 112, 74]]
            Table.new [flight, passenger, ticket_price]
        Data.Value make_table make_integer_table

add_specs suite_builder =
    suite_builder.group "running count" group_builder->
        data = Data.setup
        group_builder.specify "Defaults add running count of first column" <|
            result = data.table.running
            expected_column = Column.from_vector "Running Count of Flight" [1, 2, 3, 4, 5]
            #   | Flight | Passenger | Ticket Price | Running Count of Flight
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 1
            # 1 | BA0123 | B         | 575.99       | 2
            # 2 | SG0456 | A         | 73.23        | 3
            # 3 | BA0123 | C         | 112.34       | 4
            # 4 | SG0456 | E         | 73.77        | 5
            expected_table = data.table.zip expected_column
            result.should_equal expected_table
        group_builder.specify "Not setting the as name gives default name based on of column" <|
            result = data.table.running Statistic.Count "Passenger"
            expected_column = Column.from_vector "Running Count of Passenger" [1, 2, 3, 4, 5]
            #   | Flight | Passenger | Ticket Price | Running Count of Passenger
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 1
            # 1 | BA0123 | B         | 575.99       | 2
            # 2 | SG0456 | A         | 73.23        | 3
            # 3 | BA0123 | C         | 112.34       | 4
            # 4 | SG0456 | E         | 73.77        | 5
            expected_table = data.table.zip expected_column
            result.should_equal expected_table
        group_builder.specify "Can set the as name" <|
            result = data.table.running Statistic.Count "Passenger" "My Custom Name"
            expected_column = Column.from_vector "My Custom Name" [1, 2, 3, 4, 5]
            #   | Flight | Passenger | Ticket Price | My Custom Name
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 1
            # 1 | BA0123 | B         | 575.99       | 2
            # 2 | SG0456 | A         | 73.23        | 3
            # 3 | BA0123 | C         | 112.34       | 4
            # 4 | SG0456 | E         | 73.77        | 5
            expected_table = data.table.zip expected_column
            result.should_equal expected_table
        group_builder.specify "Setting the name the same as an existing column errors if update_mode not changed" <|
            result = data.table.running Statistic.Count "Passenger" "Passenger"
            result.should_fail_with (Existing_Column.Error 'Passenger')
        group_builder.specify "Setting the name the same as an existing column works if update_mode update" <|
            result = data.table.running Statistic.Count "Passenger" "Passenger" set_mode=..Update
            expected_column = Column.from_vector "My Custom Name" [1, 2, 3, 4, 5]
            #   | Flight | Passenger | Ticket Price 
            #---+--------+-----------+--------------
            # 0 | BA0123 | 1         | 100.5        
            # 1 | BA0123 | 2         | 575.99       
            # 2 | SG0456 | 3         | 73.23        
            # 3 | BA0123 | 4         | 112.34       
            # 4 | SG0456 | 5         | 73.77        
            expected_table = data.table.set expected_column "Passenger"
            result.should_equal expected_table
        group_builder.specify "Not setting the name updates the first column if update_mode update" <|
            result = data.table.running set_mode=..Update
            expected_column = Column.from_vector "Flight" [1, 2, 3, 4, 5]
            #   | Flight | Passenger | Ticket Price 
            #---+--------+-----------+--------------
            # 0 | 1      | A         | 100.5        
            # 1 | 2      | B         | 575.99       
            # 2 | 3      | A         | 73.23        
            # 3 | 4      | C         | 112.34       
            # 4 | 5      | E         | 73.77        
            expected_table = data.table.set expected_column
            result.should_equal expected_table
        group_builder.specify "Can group by and provide running count per group" <|
            result = data.table.running Statistic.Count "Passenger" "Passenger num per flight" group_by=["Flight"]
            expected_column = Column.from_vector "Passenger num per flight" [1, 2, 1, 3, 2]
            #   | Flight | Passenger | Ticket Price | Passenger num per flight
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 1
            # 1 | BA0123 | B         | 575.99       | 2
            # 2 | SG0456 | A         | 73.23        | 1
            # 3 | BA0123 | C         | 112.34       | 3
            # 4 | SG0456 | E         | 73.77        | 2
            expected_table = data.table.zip expected_column
            result.should_equal expected_table
        group_builder.specify "Can group by and provide running count per group based on order by" <|
            result = data.table.running Statistic.Count "Passenger" "Ranked ticket cost per pass" group_by=["Passenger"] order_by=["Ticket Price"]
            expected_column = Column.from_vector "Ranked ticket cost per pass" [2, 1, 1, 1, 1]
            #   | Flight | Passenger | Ticket Price | Ranked ticket cost per pass
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 2
            # 1 | BA0123 | B         | 575.99       | 1
            # 2 | SG0456 | A         | 73.23        | 1
            # 3 | BA0123 | C         | 112.34       | 1
            # 4 | SG0456 | E         | 73.77        | 1
            expected_table = data.table.zip expected_column
            result.should_equal expected_table
        group_builder.specify "Can provide running count based on order by without grouping" <|
            result = data.table.running Statistic.Count "Passenger" "Ranked ticket cost" order_by=["Ticket Price"]
            expected_column = Column.from_vector "Ranked ticket cost" [3, 5, 1, 4, 2]
            #   | Flight | Passenger | Ticket Price | Ranked ticket cost
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 3
            # 1 | BA0123 | B         | 575.99       | 5
            # 2 | SG0456 | A         | 73.23        | 1
            # 3 | BA0123 | C         | 112.34       | 4
            # 4 | SG0456 | E         | 73.77        | 2
            expected_table = data.table.zip expected_column
            result.should_equal expected_table
    suite_builder.group "running sum" group_builder->
        data = Data.setup
        group_builder.specify "Not setting the as name gives default name based on of column" <|
            result = data.table.running Statistic.Sum "Ticket Price"
            expected_column = Column.from_vector "Running Sum of Ticket Price" [100.5, 676.49, 749.72, 862.0600000000001, 935.83]
            #   | Flight | Passenger | Ticket Price | Running Sum of Ticket Price
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 100.5
            # 1 | BA0123 | B         | 575.99       | 676.49
            # 2 | SG0456 | A         | 73.23        | 749.72
            # 3 | BA0123 | C         | 112.34       | 862.06
            # 4 | SG0456 | E         | 73.77        | 935.83
            expected_table = data.table.zip expected_column
            result.should_equal expected_table
        group_builder.specify "Setting the name the same as an existing column errors if update_mode not changed" <|
            result = data.table.running Statistic.Sum "Ticket Price" "Ticket Price"
            result.should_fail_with (Existing_Column.Error 'Ticket Price')
        group_builder.specify "Setting the name the same as an existing column works if update_mode update" <|
            result = data.table.running Statistic.Sum "Ticket Price" "Ticket Price" set_mode=..Update
            expected_column = Column.from_vector "Ticket Price" [100.5, 676.49, 749.72, 862.0600000000001, 935.83]
            #   | Flight | Passenger | Ticket Price
            #---+--------+-----------+-------------------------
            # 0 | BA0123 | A         | 100.5
            # 1 | BA0123 | B         | 676.49
            # 2 | SG0456 | A         | 749.72
            # 3 | BA0123 | C         | 862.06
            # 4 | SG0456 | E         | 935.83
            expected_table = data.table.set expected_column "Ticket Price"
            result.should_equal expected_table
        group_builder.specify "Not setting the name overrides existing column if update_mode update" <|
            result = data.table.running Statistic.Sum "Ticket Price" set_mode=..Update
            expected_column = Column.from_vector "Ticket Price" [100.5, 676.49, 749.72, 862.0600000000001, 935.83]
            #   | Flight | Passenger | Ticket Price
            #---+--------+-----------+-------------------------
            # 0 | BA0123 | A         | 100.5
            # 1 | BA0123 | B         | 676.49
            # 2 | SG0456 | A         | 749.72
            # 3 | BA0123 | C         | 862.06
            # 4 | SG0456 | E         | 935.83
            expected_table = data.table.set expected_column "Ticket Price"
            result.should_equal expected_table
        group_builder.specify "Can group by and provide running sum per group" <|
            result = data.table.running Statistic.Sum "Ticket Price" "Running" group_by=["Flight"]
            expected_column = Column.from_vector "Running" [100.5, 676.49, 73.23, 788.83, 147]
            #   | Flight | Passenger | Ticket Price | Running
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 100.5
            # 1 | BA0123 | B         | 575.99       | 676.49
            # 2 | SG0456 | A         | 73.23        | 73.23
            # 3 | BA0123 | C         | 112.34       | 788.83
            # 4 | SG0456 | E         | 73.77        | 147
            expected_table = data.table.zip expected_column
            result.should_equal expected_table
        group_builder.specify "Can group by and provide running sum per group based on order by" <|
            result = data.table.running Statistic.Sum "Ticket Price" "Sum ticket cost per pass" group_by=["Passenger"] order_by=["Ticket Price"]
            expected_column = Column.from_vector "Sum ticket cost per pass" [173.73000000000002, 575.99, 73.23, 112.34, 73.77]
            #   | Flight | Passenger | Ticket Price | Sum ticket cost per pass
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 173.73
            # 1 | BA0123 | B         | 575.99       | 575.99
            # 2 | SG0456 | A         | 73.23        | 73.23
            # 3 | BA0123 | C         | 112.34       | 112.34
            # 4 | SG0456 | E         | 73.77        | 73.77
            expected_table = data.table.zip expected_column
            result.should_equal expected_table
        group_builder.specify "Can provide running sum based on order by without grouping" <|
            result = data.table.running Statistic.Sum "Ticket Price" "Sum ticket cost" order_by=["Ticket Price"]
            expected_column = Column.from_vector "Sum ticket cost" [247.5, 935.83, 73.23, 359.84000000000003, 147]
            #   | Flight | Passenger | Ticket Price | Sum ticket cost
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 3
            # 1 | BA0123 | B         | 575.99       | 5
            # 2 | SG0456 | A         | 73.23        | 1
            # 3 | BA0123 | C         | 112.34       | 4
            # 4 | SG0456 | E         | 73.77        | 2
            expected_table = data.table.zip expected_column
            result.should_equal expected_table
        group_builder.specify "Can provide running sum of integer columns (returning column of floats)" <|
            result = data.integer_table.running Statistic.Sum "Ticket Price" "Sum ticket cost"
            expected_column = Column.from_vector "Sum ticket cost" [101.0, 677.0, 750.0, 862.0, 936.0]
            #   | Flight | Passenger | Ticket Price | Sum ticket cost
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 101          | 101.0
            # 1 | BA0123 | B         | 576          | 677.0
            # 2 | SG0456 | A         | 73           | 750.0
            # 3 | BA0123 | C         | 112          | 862.0
            # 4 | SG0456 | E         | 74           | 936.0
            expected_table = data.integer_table.zip expected_column
            result.should_equal expected_table
    suite_builder.group "running mean" group_builder->
        data = Data.setup
        group_builder.specify "Not setting the as name gives default name based on of column" <|
            result = data.table.running Statistic.Mean "Ticket Price"
            expected_column = Column.from_vector "Running Mean of Ticket Price" [100.5, 338.245, 249.90666666666667, 215.51500000000001, 187.166]
            #   | Flight | Passenger | Ticket Price | Running Mean of Ticket Price
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 100.5
            # 1 | BA0123 | B         | 575.99       | 338.245
            # 2 | SG0456 | A         | 73.23        | 249.90666666666667
            # 3 | BA0123 | C         | 112.34       | 215.51500000000001
            # 4 | SG0456 | E         | 73.77        | 187.166
            expected_table = data.table.zip expected_column
            result.should_equal expected_table
        group_builder.specify "Can provide running mean of integer columns (returning column of floats)" <|
            result = data.integer_table.running Statistic.Mean "Ticket Price" "Mean ticket cost"
            expected_column = Column.from_vector "Mean ticket cost" [101.0, 338.5, 250, 215.5, 187.2]
            #   | Flight | Passenger | Ticket Price | Mean ticket cost
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 101          | 101.0
            # 1 | BA0123 | B         | 576          | 338.5
            # 2 | SG0456 | A         | 73           | 250
            # 3 | BA0123 | C         | 112          | 215.5
            # 4 | SG0456 | E         | 74           | 187.2
            expected_table = data.integer_table.zip expected_column
            result.should_equal expected_table
    suite_builder.group "running product" group_builder->
        data = Data.setup
        group_builder.specify "Not setting the as name gives default name based on of column" <|
            result = data.table.take 3 . running Statistic.Product "Ticket Price"
            expected_column = Column.from_vector "Running Product of Ticket Price" [100.5, 57886.995, 4239064.643850001]
            #   | Flight | Passenger | Ticket Price | Running Product of Ticket Price
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 100.5
            # 1 | BA0123 | B         | 575.99       | 57886.99
            # 2 | SG0456 | A         | 73.23        | 4239064.643850001
            expected_table = data.table.take 3 . zip expected_column
            result.should_equal expected_table
        group_builder.specify "Can provide running product of integer columns (returning column of floats)" <|
            result = data.integer_table.take 3 . running Statistic.Product "Ticket Price" "Product ticket cost"
            expected_column = Column.from_vector "Product ticket cost" [101.0, 58176.0, 4246848.0]
            #   | Flight | Passenger | Ticket Price | Product ticket cost
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 101          | 101.0
            # 1 | BA0123 | B         | 576          | 58176.0
            # 2 | SG0456 | A         | 73           | 4246848.0
            expected_table = data.integer_table.take 3 . zip expected_column
            result.should_equal expected_table
    suite_builder.group "running max" group_builder->
        data = Data.setup
        group_builder.specify "Not setting the as name gives default name based on of column" <|
            result = data.table.running Statistic.Maximum "Ticket Price"
            expected_column = Column.from_vector "Running Maximum of Ticket Price" [100.5, 575.99, 575.99, 575.99, 575.99]
            #   | Flight | Passenger | Ticket Price | Running Maximum of Ticket Price
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 100.5
            # 1 | BA0123 | B         | 575.99       | 575.99
            # 2 | SG0456 | A         | 73.23        | 575.99
            # 3 | BA0123 | C         | 112.34       | 575.99
            # 4 | SG0456 | E         | 73.77        | 575.99
            expected_table = data.table.zip expected_column
            result.should_equal expected_table
        group_builder.specify "Can provide running max of integer columns (returning column of integers)" <|
            result = data.integer_table.running Statistic.Maximum "Ticket Price" "Max ticket cost"
            expected_column = Column.from_vector "Max ticket cost" [101, 576, 576, 576, 576]
            #   | Flight | Passenger | Ticket Price | Max ticket cost
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 101          | 101
            # 1 | BA0123 | B         | 576          | 576
            # 2 | SG0456 | A         | 73           | 576
            # 3 | BA0123 | C         | 112          | 576
            # 4 | SG0456 | E         | 74           | 576
            expected_table = data.integer_table.zip expected_column
            result.should_equal expected_table
        group_builder.specify "Can provide running max of int 16 columns (returning column of int 16)" <|
            int16_col = data.integer_table.at "Ticket Price" . cast (Value_Type.Integer Bits.Bits_16)
            int16_table = data.integer_table.set int16_col "Ticket Price"
            result = int16_table.running Statistic.Maximum "Ticket Price" "Maximum ticket cost"
            expected_column = Column.from_vector "Maximum ticket cost" [101, 576, 576, 576, 576] . cast (Value_Type.Integer Bits.Bits_16)
            #   | Flight | Passenger | Ticket Price | Maximum ticket cost
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 101          | 101
            # 1 | BA0123 | B         | 576          | 576
            # 2 | SG0456 | A         | 73           | 576
            # 3 | BA0123 | C         | 112          | 576
            # 4 | SG0456 | E         | 74           | 576
            expected_table = int16_table.zip expected_column
            result.should_equal expected_table
    suite_builder.group "running min" group_builder->
        data = Data.setup
        group_builder.specify "Not setting the as name gives default name based on of column" <|
            result = data.table.running Statistic.Minimum "Ticket Price"
            expected_column = Column.from_vector "Running Minimum of Ticket Price" [100.5, 100.5, 73.23, 73.23, 73.23]
            #   | Flight | Passenger | Ticket Price | Running Minimum of Ticket Price
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 100.5
            # 1 | BA0123 | B         | 575.99       | 100.5
            # 2 | SG0456 | A         | 73.23        | 73.23
            # 3 | BA0123 | C         | 112.34       | 73.23
            # 4 | SG0456 | E         | 73.77        | 73.23
            expected_table = data.table.zip expected_column
            result.should_equal expected_table
        group_builder.specify "Can provide running min of integer columns (returning column of integers)" <|
            result = data.integer_table.running Statistic.Minimum "Ticket Price" "Min ticket cost"
            expected_column = Column.from_vector "Min ticket cost" [101, 101, 73, 73, 73]
            #   | Flight | Passenger | Ticket Price | Min ticket cost
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 101          | 101
            # 1 | BA0123 | B         | 576          | 101
            # 2 | SG0456 | A         | 73           | 73
            # 3 | BA0123 | C         | 112          | 73
            # 4 | SG0456 | E         | 74           | 73
            expected_table = data.integer_table.zip expected_column
            result.should_equal expected_table
        group_builder.specify "Can provide running min of int 16 columns (returning column of int 16)" <|
            int16_col = data.integer_table.at "Ticket Price" . cast (Value_Type.Integer Bits.Bits_16)
            int16_table = data.integer_table.set int16_col "Ticket Price"
            result = int16_table.running Statistic.Minimum "Ticket Price" "Min ticket cost"
            expected_column = Column.from_vector "Min ticket cost" [101, 101, 73, 73, 73] . cast (Value_Type.Integer Bits.Bits_16)
            #   | Flight | Passenger | Ticket Price | Min ticket cost
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 101          | 101
            # 1 | BA0123 | B         | 576          | 101
            # 2 | SG0456 | A         | 73           | 73
            # 3 | BA0123 | C         | 112          | 73
            # 4 | SG0456 | E         | 74           | 73
            expected_table = int16_table.zip expected_column
            result.should_equal expected_table
    suite_builder.group "running variance" group_builder->
        data = Data.setup
        group_builder.specify "Can calculate Variance with population" <|
            result = data.table.running (Statistic.Variance True) "Ticket Price"
            expected_column = Column.from_vector "Running (Variance True) of Ticket Price" [0.0, 56522.685024999984, 53289.11228888889, 43515.194424999994, 38026.81874399999]
            #   | Flight | Passenger | Ticket Price | Running (Variance True) of Ticket Price
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 0.0
            # 1 | BA0123 | B         | 575.99       | 56522.685024999984
            # 2 | SG0456 | A         | 73.23        | 53289.11228888889
            # 3 | BA0123 | C         | 112.34       | 43515.194424999994
            # 4 | SG0456 | E         | 73.77        | 38026.81874399999
            expected_table = data.table.zip expected_column
            result.should_equal expected_table
        group_builder.specify "Can calculate Variance without population" <|
            result = data.table.running (Statistic.Variance False) "Ticket Price"
            expected_column = Column.from_vector "Running (Variance False) of Ticket Price" [Number.nan, 113045.37004999997, 79933.66843333334, 58020.25923333332, 47533.52342999999]
            #   | Flight | Passenger | Ticket Price | Running (Variance False) of Ticket Price
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | NaN
            # 1 | BA0123 | B         | 575.99       | 113045.37004999997
            # 2 | SG0456 | A         | 73.23        | 79933.66843333334
            # 3 | BA0123 | C         | 112.34       | 58020.25923333332
            # 4 | SG0456 | E         | 73.77        | 47533.52342999999
            expected_table = data.table.zip expected_column
            result.should_equal expected_table
    suite_builder.group "running standard deviation" group_builder->
        data = Data.setup
        group_builder.specify "Can calculate Standard Deviation with population" <|
            result = data.table.running (Statistic.Standard_Deviation True) "Ticket Price"
            expected_column = Column.from_vector "Running (Standard_Deviation True) of Ticket Price" [0.0, 237.74499999999998, 230.84434645208208, 208.60295881171004, 195.00466339039176]
            #   | Flight | Passenger | Ticket Price | Running (Standard_Deviation True) of Ticket Price
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 0.0
            # 1 | BA0123 | B         | 575.99       | 237.74499999999998
            # 2 | SG0456 | A         | 73.23        | 230.84434645208208
            # 3 | BA0123 | C         | 112.34       | 208.60295881171004
            # 4 | SG0456 | E         | 73.77        | 195.00466339039176
            expected_table = data.table.zip expected_column
            result.should_equal expected_table
        group_builder.specify "Can calculate Standard Deviation without population" <|
            result = data.table.running (Statistic.Standard_Deviation False) "Ticket Price"
            expected_column = Column.from_vector "Running (Standard_Deviation False) of Ticket Price" [Number.nan, 336.2222033863914, 282.7254294069307, 240.8739488473864, 218.02184163519027]
            #   | Flight | Passenger | Ticket Price | Running (Standard_Deviation False) of Ticket Price
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | NaN
            # 1 | BA0123 | B         | 575.99       | 336.2222033863914
            # 2 | SG0456 | A         | 73.23        | 282.7254294069307
            # 3 | BA0123 | C         | 112.34       | 240.8739488473864
            # 4 | SG0456 | E         | 73.77        | 218.02184163519027
            expected_table = data.table.zip expected_column
            result.should_equal expected_table
    suite_builder.group "running skew" group_builder->
        data = Data.setup
        group_builder.specify "Can calculate skew with population" <|
            result = data.table.running (Statistic.Skew True) "Ticket Price"
            expected_column = Column.from_vector "Running (Skew True) of Ticket Price" [Number.nan, Number.nan, 0.6997131676317522, 1.138558183958172, 1.4773820041422983]
            #   | Flight | Passenger | Ticket Price | Running (Skew True) of Ticket Price
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | NaN
            # 1 | BA0123 | B         | 575.99       | NaN
            # 2 | SG0456 | A         | 73.23        | 0.6997131676317522
            # 3 | BA0123 | C         | 112.34       | 1.138558183958172
            # 4 | SG0456 | E         | 73.77        | 1.4773820041422983
            expected_table = data.table.zip expected_column
            result.should_equal expected_table
        group_builder.specify "Can calculate skew without population" <|
            result = data.table.running (Statistic.Skew False) "Ticket Price"
            expected_column = Column.from_vector "Running (Skew False) of Ticket Price" [Number.nan, Number.nan, 1.7139402270043034, 1.9720406219889064, 2.202351059998037]
            #   | Flight | Passenger | Ticket Price | Running (Skew False) of Ticket Price
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | NaN
            # 1 | BA0123 | B         | 575.99       | NaN
            # 2 | SG0456 | A         | 73.23        | 1.7139402270043034
            # 3 | BA0123 | C         | 112.34       | 1.9720406219889064
            # 4 | SG0456 | E         | 73.77        | 2.202351059998037
            expected_table = data.table.zip expected_column
            result.should_equal expected_table
    suite_builder.group "running kurtosis" group_builder->
        data = Data.setup
        group_builder.specify "Can calculate kurtosis" <|
            result = data.table.running Statistic.Kurtosis "Ticket Price"
            expected_column = Column.from_vector "Running Kurtosis of Ticket Price" [Number.nan, Number.nan, Number.nan, 3.910697052351704, 4.878357490643253]
            #   | Flight | Passenger | Ticket Price | Running Kurtosis of Ticket Price
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | NaN
            # 1 | BA0123 | B         | 575.99       | NaN
            # 2 | SG0456 | A         | 73.23        | NaN
            # 3 | BA0123 | C         | 112.34       | 3.910697052351704
            # 4 | SG0456 | E         | 73.77        | 4.878357490643253
            expected_table = data.table.zip expected_column
            result.should_equal expected_table
    suite_builder.group "nothing handling" group_builder->
        #   | Flight | Passenger | Ticket Price
        #---+--------+-----------+--------------
        # 0 | BA0123 | A         | 100.5
        # 1 | BA0123 | B         | 575.99
        # 2 | SG0456 | A         | nothing
        # 3 | BA0123 | C         | nothing
        # 4 | SG0456 | E         | 73.77
        flight = ["Flight", ["BA0123", "BA0123", "SG0456", "BA0123", "SG0456"]]
        passenger = ["Passenger", ["A", "B", "A", "C", "E"]]
        ticket_price = ["Ticket Price", [100.50, 575.99, Nothing, Nothing, 73.77]]
        table = Table.new [flight, passenger, ticket_price]
        group_builder.specify "Running count doesn't care about nothing values" <|
            result = table.running Statistic.Count "Passenger"
            expected_column = Column.from_vector "Running Count of Passenger" [1, 2, 3, 4, 5]
            #   | Flight | Passenger | Ticket Price | Running Count of Passenger
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 1
            # 1 | BA0123 | B         | 575.99       | 2
            # 2 | SG0456 | A         | nothing      | 3
            # 3 | BA0123 | C         | nothing      | 4
            # 4 | SG0456 | E         | 73.77        | 5
            expected_table = table.zip expected_column
            result.should_equal expected_table
            warnings = Problems.get_attached_warnings result
            warnings.not_empty . should_be_false
        group_builder.specify "Running sum works ignores nothing values and warns" <|
            result = table.running Statistic.Sum "Ticket Price"
            expected_column = Column.from_vector "Running Sum of Ticket Price" [100.5, 676.49, 676.49, 676.49, 750.26]
            #   | Flight | Passenger | Ticket Price | Running Sum of Ticket Price
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 100.5
            # 1 | BA0123 | B         | 575.99       | 676.49
            # 2 | SG0456 | A         | Nothing      | 676.49
            # 3 | BA0123 | C         | Nothing      | 676.49
            # 4 | SG0456 | E         | 73.77        | 750.26
            expected_table = table.zip expected_column
            result.should_equal expected_table
            w = Problems.expect_warning Ignored_Nothing_Values result
            w.column.should_equal "Ticket Price"
            w.rows.should_equal [2, 3]
        group_builder.specify "Running sum works ignores nothing values and warnings can be hushed" <|
            result = table.running Statistic.Sum "Ticket Price" on_problems=..Ignore
            expected_column = Column.from_vector "Running Sum of Ticket Price" [100.5, 676.49, 676.49, 676.49, 750.26]
            #   | Flight | Passenger | Ticket Price | Running Sum of Ticket Price
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 100.5
            # 1 | BA0123 | B         | 575.99       | 676.49
            # 2 | SG0456 | A         | Nothing      | 676.49
            # 3 | BA0123 | C         | Nothing      | 676.49
            # 4 | SG0456 | E         | 73.77        | 750.26
            expected_table = table.zip expected_column
            result.should_equal expected_table
            warnings = Problems.get_attached_warnings result
            warnings.not_empty . should_be_false
        group_builder.specify "Running min ignores nothing values and works with grouping and warns" <|
            result = table.running Statistic.Minimum "Ticket Price" "Running" group_by=["Flight"]
            expected_column = Column.from_vector "Running" [100.5, 100.5, Nothing, 100.5, 73.77]
            #   | Flight | Passenger | Ticket Price | Running
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 100.5
            # 1 | BA0123 | B         | 575.99       | 100.5
            # 2 | SG0456 | A         | Nothing      | Nothing
            # 3 | BA0123 | C         | Nothing      | 100.5
            # 4 | SG0456 | E         | 73.77        | 73.77
            expected_table = table.zip expected_column
            result.should_equal expected_table
            w = Problems.expect_warning Ignored_Nothing_Values result
            w.column.should_equal "Ticket Price"
            w.rows.should_equal [2, 3]
        group_builder.specify "Running max ignores nothing values and works with grouping and warns" <|
            result = table.running Statistic.Maximum "Ticket Price" "Running" group_by=["Flight"]
            expected_column = Column.from_vector "Running" [100.5, 575.99, Nothing, 575.99, 73.77]
            #   | Flight | Passenger | Ticket Price | Running
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 100.5
            # 1 | BA0123 | B         | 575.99       | 575.99
            # 2 | SG0456 | A         | Nothing      | Nothing
            # 3 | BA0123 | C         | Nothing      | 575.99
            # 4 | SG0456 | E         | 73.77        | 73.77
            expected_table = table.zip expected_column
            result.should_equal expected_table
            w = Problems.expect_warning Ignored_Nothing_Values result
            w.column.should_equal "Ticket Price"
            w.rows.should_equal [2, 3]
        group_builder.specify "Running mean ignores nothing values and warns" <|
            result = table.running Statistic.Mean "Ticket Price" "Running"
            expected_column = Column.from_vector "Running" [100.5, 338.245, 338.245, 338.245, 250.08666666666667]
            #   | Flight | Passenger | Ticket Price | Running
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 100.5
            # 1 | BA0123 | B         | 575.99       | 338.245
            # 2 | SG0456 | A         | Nothing      | 338.245
            # 3 | BA0123 | C         | Nothing      | 338.245
            # 4 | SG0456 | E         | 73.77        | 250.08666666666667
            expected_table = table.zip expected_column
            result.should_equal expected_table
            w = Problems.expect_warning Ignored_Nothing_Values result
            w.column.should_equal "Ticket Price"
            w.rows.should_equal [2, 3]
        group_builder.specify "Running mean ignores nothing values and works when first value is Nothing and warns" <|
            result = table.running Statistic.Mean "Ticket Price" "Running" group_by=["Flight"]
            expected_column = Column.from_vector "Running" [100.5, 338.245, Nothing, 338.245, 73.77]
            #   | Flight | Passenger | Ticket Price | Running
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 100.5
            # 1 | BA0123 | B         | 575.99       | 338.245
            # 2 | SG0456 | A         | Nothing      | Nothing
            # 3 | BA0123 | C         | Nothing      | 338.245
            # 4 | SG0456 | E         | 73.77        | 73.77
            expected_table = table.zip expected_column
            result.should_equal expected_table
            w = Problems.expect_warning Ignored_Nothing_Values result
            w.column.should_equal "Ticket Price"
            w.rows.should_equal [2, 3]
    suite_builder.group "NaN handling" group_builder->
        #   | Flight | Passenger | Ticket Price
        #---+--------+-----------+--------------
        # 0 | BA0123 | A         | 100.5
        # 1 | BA0123 | B         | 575.99
        # 2 | SG0456 | A         | NaN
        # 3 | BA0123 | C         | NaN
        # 4 | SG0456 | E         | 73.77
        flight = ["Flight", ["BA0123", "BA0123", "SG0456", "BA0123", "SG0456"]]
        passenger = ["Passenger", ["A", "B", "A", "C", "E"]]
        ticket_price = ["Ticket Price", [100.50, 575.99, Number.nan, Number.nan, 73.77]]
        table = Table.new [flight, passenger, ticket_price]
        group_builder.specify "Running count doesn't care about NaN values" <|
            result = table.running Statistic.Count "Passenger"
            expected_column = Column.from_vector "Running Count of Passenger" [1, 2, 3, 4, 5]
            #   | Flight | Passenger | Ticket Price | Running Count of Passenger
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 1
            # 1 | BA0123 | B         | 575.99       | 2
            # 2 | SG0456 | A         | nothing      | 3
            # 3 | BA0123 | C         | nothing      | 4
            # 4 | SG0456 | E         | 73.77        | 5
            expected_table = table.zip expected_column
            result.should_equal expected_table
            warnings = Problems.get_attached_warnings result
            warnings.not_empty . should_be_false
        group_builder.specify "Running sum works ignores NaN values and warns" <|
            result = table.running Statistic.Sum "Ticket Price"
            expected_column = Column.from_vector "Running Sum of Ticket Price" [100.5, 676.49, 676.49, 676.49, 750.26]
            #   | Flight | Passenger | Ticket Price | Running Sum of Ticket Price
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 100.5
            # 1 | BA0123 | B         | 575.99       | 676.49
            # 2 | SG0456 | A         | NaN          | 676.49
            # 3 | BA0123 | C         | NaN          | 676.49
            # 4 | SG0456 | E         | 73.77        | 750.26
            expected_table = table.zip expected_column
            result.should_equal expected_table
            w = Problems.expect_warning Ignored_NaN_Values result
            w.column.should_equal "Ticket Price"
            w.rows.should_equal [2, 3]
        group_builder.specify "Running sum works ignores NaN values and warnings can be hushed" <|
            result = table.running Statistic.Sum "Ticket Price" on_problems=..Ignore
            expected_column = Column.from_vector "Running Sum of Ticket Price" [100.5, 676.49, 676.49, 676.49, 750.26]
            #   | Flight | Passenger | Ticket Price | Running Sum of Ticket Price
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 100.5
            # 1 | BA0123 | B         | 575.99       | 676.49
            # 2 | SG0456 | A         | NaN          | 676.49
            # 3 | BA0123 | C         | NaN          | 676.49
            # 4 | SG0456 | E         | 73.77        | 750.26
            expected_table = table.zip expected_column
            result.should_equal expected_table
            warnings = Problems.get_attached_warnings result
            warnings.not_empty . should_be_false
        group_builder.specify "Running min ignores NaN values and works with grouping and warns" <|
            result = table.running Statistic.Minimum "Ticket Price" "Running" group_by=["Flight"]
            expected_column = Column.from_vector "Running" [100.5, 100.5, Number.nan, 100.5, 73.77]
            #   | Flight | Passenger | Ticket Price | Running
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 100.5
            # 1 | BA0123 | B         | 575.99       | 100.5
            # 2 | SG0456 | A         | NaN          | NaN
            # 3 | BA0123 | C         | NaN          | 100.5
            # 4 | SG0456 | E         | 73.77        | 73.77
            expected_table = table.zip expected_column
            result.should_equal expected_table
            w = Problems.expect_warning Ignored_NaN_Values result
            w.column.should_equal "Ticket Price"
            w.rows.should_equal [2, 3]
        group_builder.specify "Running max ignores NaN values and works with grouping and warns" <|
            result = table.running Statistic.Maximum "Ticket Price" "Running" group_by=["Flight"]
            expected_column = Column.from_vector "Running" [100.5, 575.99, Number.nan, 575.99, 73.77]
            #   | Flight | Passenger | Ticket Price | Running
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 100.5
            # 1 | BA0123 | B         | 575.99       | 575.99
            # 2 | SG0456 | A         | NaN          | NaN
            # 3 | BA0123 | C         | NaN          | 575.99
            # 4 | SG0456 | E         | 73.77        | 73.77
            expected_table = table.zip expected_column
            result.should_equal expected_table
            w = Problems.expect_warning Ignored_NaN_Values result
            w.column.should_equal "Ticket Price"
            w.rows.should_equal [2, 3]
        group_builder.specify "Running mean ignores NaN values and warns" <|
            result = table.running Statistic.Mean "Ticket Price" "Running"
            expected_column = Column.from_vector "Running" [100.5, 338.245, 338.245, 338.245, 250.08666666666667]
            #   | Flight | Passenger | Ticket Price | Running
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 100.5
            # 1 | BA0123 | B         | 575.99       | 338.245
            # 2 | SG0456 | A         | NaN          | 338.245
            # 3 | BA0123 | C         | NaN          | 338.245
            # 4 | SG0456 | E         | 73.77        | 250.08666666666667
            expected_table = table.zip expected_column
            result.should_equal expected_table
            w = Problems.expect_warning Ignored_NaN_Values result
            w.column.should_equal "Ticket Price"
            w.rows.should_equal [2, 3]
        group_builder.specify "Running mean ignores NaN values and works when first value is NaN and warns" <|
            result = table.running Statistic.Mean "Ticket Price" "Running" group_by=["Flight"]
            expected_column = Column.from_vector "Running" [100.5, 338.245, Number.nan, 338.245, 73.77]
            #   | Flight | Passenger | Ticket Price | Running
            #---+--------+-----------+--------------+-------------------------
            # 0 | BA0123 | A         | 100.5        | 100.5
            # 1 | BA0123 | B         | 575.99       | 338.245
            # 2 | SG0456 | A         | NaN          | NaN
            # 3 | BA0123 | C         | NaN          | 338.245
            # 4 | SG0456 | E         | 73.77        | 73.77
            expected_table = table.zip expected_column
            result.should_equal expected_table
            w = Problems.expect_warning Ignored_NaN_Values result
            w.column.should_equal "Ticket Price"
            w.rows.should_equal [2, 3]
    suite_builder.group "different types" group_builder->
        #   | Flight | Passenger | Ticket Price
        #---+--------+-----------+--------------
        # 0 | BA0123 | A         | 1
        # 1 | BA0123 | B         | 2
        # 2 | SG0456 | A         | 3
        # 3 | BA0123 | C         | 4
        # 4 | SG0456 | E         | 5
        flight = ["Flight", ["BA0123", "BA0123", "SG0456", "BA0123", "SG0456"]]
        passenger = ["Passenger", ["A", "B", "A", "C", "E"]]
        ticket_price = ["Ticket Price", [1, 2, 3, 4, 5]]
        table = Table.new [flight, passenger, ticket_price]
        group_builder.specify "Running sum works over an integer column" <|
            result = table.running Statistic.Sum "Ticket Price"
            expected_column = Column.from_vector "Running Sum of Ticket Price" [1.0, 3.0, 6.0, 10.0, 15.0]
            #   | Flight | Passenger | Ticket Price | Running Sum of Ticket Price
            #---+--------+-----------+--------------+------------------------------
            # 0 | BA0123 | A         | 1            | 1.0
            # 1 | BA0123 | B         | 2            | 3.0
            # 2 | SG0456 | A         | 3            | 6.0
            # 3 | BA0123 | C         | 4            | 10.0
            # 4 | SG0456 | E         | 5            | 15.0
            expected_table = table.zip expected_column
            result.should_equal expected_table
        group_builder.specify "Running sum does not work over a string column" <|
            (table.running Statistic.Sum "Passenger").should_fail_with Invalid_Value_Type
    suite_builder.group "Unsupported statistics" group_builder->
        data = Data.setup
        group_builder.specify "RSquared is not supported" <|
            (data.table.running (Statistic.R_Squared [1, 2 ,3]) "Ticket Price").should_fail_with Illegal_Argument
        group_builder.specify "Covariance is not supported" <|
            (data.table.running (Statistic.Covariance []) "Ticket Price").should_fail_with Illegal_Argument
        group_builder.specify "Pearson is not supported" <|
            (data.table.running (Statistic.Pearson []) "Ticket Price").should_fail_with Illegal_Argument
        group_builder.specify "Spearman is not supported" <|
            (data.table.running (Statistic.Spearman []) "Ticket Price").should_fail_with Illegal_Argument

main filter=Nothing =
    suite = Test.build suite_builder->
        add_specs suite_builder
    suite.run_with_filter filter

