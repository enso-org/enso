from Standard.Base import all
import Standard.Base.Errors.Unimplemented.Unimplemented

from Standard.Table import Aggregate_Column, Join_Kind
import Standard.Table.Internal.Naming_Helpers.Naming_Helpers
import Standard.Table.Internal.Problem_Builder.Problem_Builder

import project.Connection.Connection.Connection
import project.Data.SQL_Statement.SQL_Statement
import project.Data.SQL_Type.SQL_Type
import project.Data.Table.Table
import project.Internal.Column_Fetcher.Column_Fetcher
import project.Internal.IR.From_Spec.From_Spec
import project.Internal.IR.Internal_Column.Internal_Column
import project.Internal.IR.Order_Descriptor.Order_Descriptor
import project.Internal.IR.Query.Query
import project.Internal.Postgres.Postgres_Dialect
import project.Internal.Redshift.Redshift_Dialect
import project.Internal.SQLite.SQLite_Dialect
import project.Internal.SQL_Type_Mapping.SQL_Type_Mapping
import project.Internal.Statement_Setter.Statement_Setter
from project.Errors import Unsupported_Database_Operation

## PRIVATE

   Represents a specific SQL dialect.

   It encapsulates dialect-specific code generation details allowing us to
   support differing SQL dialects.
type Dialect
    ## PRIVATE
       Name of the dialect.
    name : Text
    name self = Unimplemented.throw "This is an interface only."

    ## PRIVATE
       A function which generates SQL code from the internal representation
       according to the specific dialect.
    generate_sql : Query -> SQL_Statement
    generate_sql self query =
        _ = [query]
        Unimplemented.throw "This is an interface only."

    ## PRIVATE
       Prepares an ordering descriptor.

       One of the purposes of this method is to verify if the expected ordering
       settings are supported by the given database backend.

       Arguments:
       - internal_column: the column to order by.
       - sort_direction: the direction of the ordering.
       - text_ordering: If provided, specifies that the column should be treated
         as text values according to the provided ordering. For non-text types,
         it should be set to `Nothing`.
    prepare_order_descriptor : Internal_Column -> Sort_Direction -> Nothing | Text_Ordering -> Order_Descriptor
    prepare_order_descriptor self internal_column sort_direction text_ordering =
        _ = [internal_column, sort_direction, text_ordering]
        Unimplemented.throw "This is an interface only."

    ## PRIVATE
       Prepares a join operation, returning a new table instance encapsulating a
       proper query.
    prepare_join : Connection -> Join_Kind -> Text -> From_Spec -> From_Spec -> Vector -> Vector -> Vector -> Table
    prepare_join self connection join_kind new_table_name left_subquery right_subquery on_expressions where_expressions columns_to_select =
        _ = [connection, join_kind, new_table_name, left_subquery, right_subquery, on_expressions, where_expressions, columns_to_select]
        Unimplemented.throw "This is an interface only."

    ## PRIVATE
       Prepares a distinct operation.
    prepare_distinct : Table -> Vector -> Case_Sensitivity -> Problem_Builder -> Table
    prepare_distinct self table key_columns case_sensitivity problem_builder =
        _ = [table, key_columns, case_sensitivity, problem_builder]
        Unimplemented.throw "This is an interface only."

    ## PRIVATE
       A heuristic used by `Connection.query` to determine if a given text looks
       like a SQL query for the given dialect or is rather a table name.
    is_probably_a_query : Text -> Boolean
    is_probably_a_query self text =
        _ = [text]
        Unimplemented.throw "This is an interface only."

    ## PRIVATE
       Returns an utility that allows ensuring column names are valid for the
       given backend.
    get_naming_helpers : Naming_Helpers
    get_naming_helpers self =
        Unimplemented.throw "This is an interface only."

    ## PRIVATE
       Returns the mapping between SQL types of this dialect and Enso
       `Value_Type`.
    get_type_mapping : SQL_Type_Mapping
    get_type_mapping self =
        Unimplemented.throw "This is an interface only."

    ## PRIVATE
       Creates a `Column_Fetcher` used to fetch data from a result set and build
       an in-memory column from it, based on the given column type.
    make_column_fetcher_for_type : SQL_Type -> Column_Fetcher
    make_column_fetcher_for_type self sql_type =
        _ = sql_type
        Unimplemented.throw "This is an interface only."

    ## PRIVATE
       Returns a helper object that handles the logic of setting values in a
       prepared statement.

       This object may provide custom logic for handling dialect-specific
       handling of some types.
    get_statement_setter : Statement_Setter
    get_statement_setter self =
        Unimplemented.throw "This is an interface only."

    ## PRIVATE
       Checks if the given aggregate is supported.

       Should raise an appropriate dataflow error if not, or just return `True`.
    check_aggregate_support : Aggregate_Column -> Boolean ! Unsupported_Database_Operation
    check_aggregate_support self aggregate =
        _ = aggregate
        Unimplemented.throw "This is an interface only."

## PRIVATE

   The dialect of SQLite databases.
sqlite : Dialect
sqlite = SQLite_Dialect.sqlite

## PRIVATE

   The dialect of PostgreSQL databases.
postgres : Dialect
postgres = Postgres_Dialect.postgres

## PRIVATE

   The dialect of Redshift databases.
redshift : Dialect
redshift = Redshift_Dialect.redshift
